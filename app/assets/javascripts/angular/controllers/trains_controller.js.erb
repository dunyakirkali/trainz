trainzApp.controller('TrainsController', ['$scope', 'D3Service', 'AudioService', 'DKOverlay',
function ($scope, D3Service, AudioService, DKOverlay) {  
  $scope.trains = [{
    name: 'Dunya',
    controls: {
      speed: 0.0001
    }
    // carriages: 
  }];
  $scope.timer;
  
  $scope.horn = function () {
    AudioService.play();
  };
    
  $scope.speedChanged = function() {
    D3Service.setSpeed($scope.trains[0].controls.speed);
  };
  
  $scope.initDrawMap = function() {
    var sPoint = D3Service.startPoint();
    
    var mapOptions = { 
      zoom: 14, 
      center: new google.maps.LatLng(sPoint.y, sPoint.x),
      mapTypeControlOptions: {
         mapTypeIds: []
      },
      mapTypeId: google.maps.MapTypeId.SATELLITE,
      draggable: false,
      zoomControl: true,
      scrollwheel: false,
      disableDoubleClickZoom: true
    };
    $scope.draw_map = new google.maps.Map(d3.select("#google_map").node(), mapOptions);
    $scope.overlay = new DKOverlay($scope.draw_map);
    $scope.overlay.setMap($scope.draw_map);  
    google.maps.event.addListener($scope.draw_map, 'idle', function() {
      if(!$scope.timer) {
        $scope.timer = setInterval(function() {
          $scope.overlay.draw();
        },30);
      }
    });
  };
  
  AudioService.init();
  D3Service.init();
  D3Service.animate();
  
  $scope.initDrawMap();
}]);
trainzApp.controller('TrainsController', ['$scope', 'AudioService', 'osmAPI', 'overpassAPI',
function ($scope, AudioService, osmAPI, overpassAPI) {
  // TEMP
  $scope.trainPathCoordinates = [];
  // Trains
  $scope.config = {
    controls: {
      speed: 0.0001,
      follow: false
    }
  };

  $scope.timer;
  $scope.followIndex = 0;
  $scope.routes = []

  $scope.horn = function () {
    AudioService.play();
  };

  $scope.speedChanged = function() {
    AudioService.setSpeed($scope.config.controls.speed / 350.);
    $scope.overlay.speed = $scope.config.controls.speed;
  };

  $scope.followChanged = function() {
    $scope.overlay.follow = $scope.config.controls.follow;
  };
  $scope.followIndexChanged = function() {
    $scope.overlay.setFollowIndex($scope.followIndex);
  };

  $scope.displayTrain = function(train) {
    $('.messages').html('loading train...');
    osmAPI.get('/0.6/relation/' + train.id, {}).then(function(data) {
      $(data).find('member[type="way"]').each(function(index, way) {
        osmAPI.get('/0.6/way/' + $(way).attr('ref'), {}).then(function(way_data) {
          osmAPI.get('/0.6/node/' + $(way_data).find('nd').attr('ref'), {}).then(function(node_data) {
            $(node_data).find('node').each(function(index, node) {
              $scope.trainPathCoordinates.push({
                lat: parseFloat($(node).attr('lat')),
                lng: parseFloat($(node).attr('lon'))
              });
            });

            var line = new google.maps.Polyline({
              path: $scope.trainPathCoordinates,
              geodesic: true,
              strokeColor: "#FF0000",
              strokeOpacity: 1.0,
              strokeWeight: 3
            });

            line.setMap($scope.draw_map);
          });
        });
      });
      $('.messages').html('');
    });
  };

  // AudioService.init();
}]);

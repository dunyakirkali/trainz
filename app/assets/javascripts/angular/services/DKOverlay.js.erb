DKOverlay.prototype = new google.maps.OverlayView();

function DKOverlay(map) {
  this.speed = 0.001;
  this.time = 0.0;
  this.gmap = map;
  this.div;
  this.svg;
  this.group;
  this.circles = [];    
  this.pathNode;
  this.pathLength;
  this.dataLoaded = false;
}

DKOverlay.prototype.onAdd = function() {

  var that = this;
  
  this.div = d3.select(this.getPanes().overlayLayer).append("div").attr("id", "d3map");
  this.svg = this.div.append('svg:svg');

  d3.json("<%= asset_path 'track.json' %>", function(json) {
    console.log(json.features);
    that.addTrack(json.features);
    that.dataLoaded = true;
  });
     
  google.maps.event.addListener(map, 'bounds_changed', that.draw);
  google.maps.event.addListener(map, 'center_changed', that.draw);
};

DKOverlay.prototype.addTrack = function(track) { 
  var tracks = this.svg.append("svg:g").attr("id", "tracks");
  tracks.selectAll("path").data(track).enter().append("svg:path").attr('class', 'track');
  // this.targetPath = d3.selectAll('#tracks')[0][0];
  // this.pathNode = d3.select(this.targetPath).selectAll('path').node();
  // this.pathLength = this.pathNode.getTotalLength();
};


//
// Draw
//
DKOverlay.prototype.draw = function() {  
  if(!this.dataLoaded) return;
  
  var bounds = this.gmap.getBounds();
  var projection = d3.geo.mercator().rotate([-bounds.getCenter().lng(),0]).translate([0, 0]).scale(1);
  var path = d3.geo.path().projection(projection);
  
  var ne = bounds.getNorthEast(),
      sw = bounds.getSouthWest();
          
  var p1 = projection([ne.lng(),ne.lat()]),
      p2 = projection([sw.lng(),sw.lat()]);
       
  // this.svg.select('#tracks').attr('transform', 
  //         'scale('+ $('#d3map').width()/(p1[0]-p2[0])+','+$('#d3map').height()/(p2[1]-p1[1])+')'+
  //         'translate('+(-p2[0])+','+(-p1[1])+') ');
  this.svg.select('#tracks').selectAll('path').attr('d', path);  
      
  // this.tracks_group.attr('transform', 
  //     'scale(' + $('.tracks').width() / (p1[0]-p2[0]) + ',' + $('.tracks').height() / (p2[1] - p1[1]) + ')');
  //     // 'translate('+(-p2[0])+','+(+p1[1])+') ');
  //     
  //     // console.log($('.tracks').width() / (p1[0]-p2[0]));
  //     
  // this.group.attr('transform', 
  //     // 'scale(' + $('.tracks').width() / (p1[0]-p2[0]) + ',' + $('.tracks').height() / (p2[1] - p1[1]) + ')' +
  //     'translate('+(-p2[0])+','+(+p1[1])+') ');
  // this.vis.selectAll('path').attr('d', path);
 // 
 //  this.time += this.speed;
 //  var that = this;
 // for(var i = 0; i < this.circles.length; i++) {
 // 
 //    this.circles[i].attr({
 //      fill: "#a32",
 //      transform: function () {
 //        var nT = that.time;
 //        nT = nT - Math.floor(nT);
 //        var p = that.pathNode.getPointAtLength(that.pathLength * nT);
 //        var isoX = p.x;
 //        var isoY = p.y;
 //        return "translate(" + [isoX, isoY] + ")";
 //      }
 //    });//.attr('transform', 'translate('+(-p2[0])+','+(+p1[1])+') ');
 //  }
};

DKOverlay.prototype.onRemove = function() {  
  // this.vis.parentNode.removeChild(this.vis);
  // this.vis = null;
  // this.setMap(null);
};

trainzApp.factory('DKOverlay', function ($rootScope) {
  return DKOverlay;
});